<!--
Modified and derived from
<http://www.html5rocks.com/en/tutorials/file/dndfiles/#toc-selecting-files-dnd>
<http://bl.ocks.org/mbostock/4063663>

Code by the Illinois VLSI CAD teaching staff.
Released under the University of Illinois/NCSA Open Source License
-->

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>

<title>
  Visualize Routes for Programming Assignment #4
</title>
<script type="text/javascript" src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

<style>
  /* For drag-n-drop */
  .drop_zone{
    border:2px dashed #bbb;
    -moz-border-radius:5px;
    -webkit-border-radius:5px;
    border-radius:5px;
    padding:25px;
    margin-bottom: 5px;
    margin-top: 5px;
    text-align:center;
    font:20pt bold,"Vollkorn";
    color:#bbb
  }

  /* For actual chart */
  svg {
      font: 10px sans-serif;
      padding: 10px;
  }

  .axis,
  .frame {
      shape-rendering: crispEdges;
  }

  .axis line {
      stroke: #ddd;
  }

  .axis path {
      display: none;
  }

  .frame {
      fill: none;
        stroke: #aaa;
  }
</style>
</head>
<body>
<div id="benchmark_zone" class="drop_zone">1) Drop benchmark file here</div>
<div id="router_zone" class="drop_zone">2) Drop router results file here</div>

<script>

if (window.File && window.FileReader && window.FileList && window.Blob) {
  // Great success! All the File APIs are supported.
} else {
  alert('The File APIs are not fully supported in this browser. Consider using one from http://www.html5rocks.com/en/features/file_access');
}

function handleFileSelectBenchmark(evt) {
  evt.stopPropagation();
  evt.preventDefault();

  var files = evt.dataTransfer.files; // FileList object.

  // User can drag-n-drop multiple files at once so we pick only the first one.
  // I don't know of a way to prevent drag-n-drop of multiple files at once.

  var csv = files[0];
  var reader = new FileReader();
  reader.onload = function(event) {
    var NUM_LAYERS = 2;
    var rawText = event.target.result;
    var lines = rawText.split("\n");

    var data = [];

    var numVCells, numHCells, lineIndex, rawLine, splitData;

    // First line specifies size of grid
    splitData = lines[0].trim().split(/\s+/);
    numHCells = parseInt(splitData[0]);
    numVCells = parseInt(splitData[1]);

    // Subsequent lines specify data for each grid
    // We know that we have numVCells * NUM_LAYERS of lines to read
    var currentX = 0, currentY = 0, layer = 1, attribute;
    for(lineIndex = 1; lineIndex < numVCells * NUM_LAYERS; lineIndex++) {
      rawLine = lines[lineIndex];
      if(!isBlank(rawLine)) {
        splitData = rawLine.trim().split(/\s+/);
        for(currentX = 0; currentX < numHCells; currentX++) {
          attribute = parseInt(splitData[currentX]);
          data.push({x: currentX, y: currentY, layer: layer, attribute: attribute});
        }
      }

      currentY++;
      if(currentY == numVCells) {
        currentY = 0;
        layer++;
      }
    }

    drawGrid(numHCells, numVCells, data);
  };

  reader.readAsText(csv);
}

var isBlank = function(string) {
  return (!string || /^\s*$/.test(string));
}

function handleDragOverBenchmark(evt) {
  evt.stopPropagation();
  evt.preventDefault();
  evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
}

function handleFileSelectRouter(evt) {
  evt.stopPropagation();
  evt.preventDefault();

  var files = evt.dataTransfer.files; // FileList object.

  // User can drag-n-drop multiple files at once so we pick only the first one.
  // I don't know of a way to prevent drag-n-drop of multiple files at once.

  var csv = files[0];
  var reader = new FileReader();
  reader.onload = function(event) {
    var rawText = event.target.result;
    var data = d3.csv.parse(rawText);
    drawVisualization(data);
  };
  reader.readAsText(csv);
}

function handleDragOverRouter(evt) {
  evt.stopPropagation();
  evt.preventDefault();
  evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
}

// Setup the dnd listeners.
var benchmarkZone = document.getElementById('benchmark_zone');
benchmarkZone.addEventListener('dragover', handleDragOverBenchmark, false);
benchmarkZone.addEventListener('drop', handleFileSelectBenchmark, false);

var routerZone = document.getElementById('router_zone');
routerZone.addEventListener('dragover', handleDragOverRouter, false);
routerZone.addEventListener('drop', handleFileSelectRouter, false);


function drawGrid(numHCells, numVCells, data) {
  var CELL_SIZE = 40;

  d3.select("svg").remove();

  var padding = 25,
  hSize = CELL_SIZE * numHCells,
  vSize = CELL_SIZE * numVCells;

  var x = d3.scale.linear()
  .domain([0, numHCells])
  .range([padding / 2, hSize + padding / 2]);

  var y = d3.scale.linear()
  .domain([0, numVCells])
  .range([vSize + padding / 2, padding / 2]);

  var xAxis = d3.svg.axis()
  .scale(x)
  .orient("bottom")
  .ticks(numHCells)
  .tickSize(-(vSize + padding));

  var yAxis = d3.svg.axis()
  .scale(y)
  .orient("left")
  .ticks(numVCells)
  .tickSize(-(hSize + padding));

  var svg = d3.select("body").append("svg")
  .attr("width", hSize + padding * 2)
  .attr("height", vSize + padding * 2)
  .append("g")
  .attr("transform", "translate(" + padding / 2 + "," + padding / 2 + ")");

  var xAxisGroup = svg.append("g")
  .attr("class", "x axis")
  .attr("transform", "translate(0," + (vSize + padding) + ")")
  .call(xAxis);

  var yAxisGroup = svg.append("g")
  .attr("class", "y axis")
  .call(yAxis);

  // Need to shift the y-axis by cellHeight so that (0,0) is within the cell
  // Recall that the position of rect is determined by its top left corner
  var yShift = d3.scale.linear()
  .domain([0, numVCells])
  .range([vSize + padding / 2 - CELL_SIZE, padding / 2 - CELL_SIZE]);

  // Populate with new data
  svg.selectAll("rect")
  .data(data)
  .enter()
  .append("rect")
  .attr("x", function(d) {
    return x(d.x)})
  .attr("y", function(d) {
    return yShift(d.y)})
  .attr("width", CELL_SIZE)
  .attr("height", CELL_SIZE)
  .attr("fill-opacity", 0.2)
  .style("fill", function(d) {
    if(d.attribute == -1)
      return d3.rgb("black");
    else
      return "none";
     });
}

</script>
</body>
</html>

